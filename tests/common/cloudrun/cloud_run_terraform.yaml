# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# [START cloudbuild_python_yaml]
# [START cloudbuild_python_dependencies_yaml]
steps:

  # Install dependencies
  - name: 'alpine'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "***********************"
        echo "Branch name is $BRANCH_NAME"
        echo "Bucket name is $_BUCKET_NAME"
        cp common/cloudrun/* /workspace/.
        echo "***********************"
  # [END cloudbuild_python_dependencies_yaml]
  # Install dependencies
  - name: python
    entrypoint: pip
    args: ["install", "-r", "requirements.txt", "--user"]
# [END cloudbuild_python_dependencies_yaml]

  # [START cloudbuild_python_image_yaml]
  # Docker Build
#  - name: google/cloud-sdk
#    args: ['gcloud', 'beta', 'artifacts', 'repositories', 'create', 'hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}',
#'--repository-format', 'docker', '--location', 'europe-west1', '--description', 'Artifact repo for call parallel API']
  # [END cloudbuild_python_image_yaml]

  # [START cloudbuild_python_image_yaml]
  # Docker Build
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t',
           'europe-west1-docker.pkg.dev/${PROJECT_ID}/hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}/cloud-run-parallel-api:latest', '.']
  # [END cloudbuild_python_image_yaml]

  # [START cloudbuild_python_push_yaml]
  # Docker push to Google Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push',  'europe-west1-docker.pkg.dev/${PROJECT_ID}/hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}/cloud-run-parallel-api:latest']
  # [END cloudbuild_python_push_yaml]

  # [START cloudbuild_python_deploy_yaml]
  # Deploy to Cloud Run
#  - name: google/cloud-sdk
#    args: ['gcloud', 'run', 'jobs', 'deploy', 'hrdp-cr-perf-goals-cloud-run-ew1-${BRANCH_NAME}',
#           '--image=europe-west1-docker.pkg.dev/${PROJECT_ID}/hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}/cloud-run-parallel-api:latest',
#           '--command','python', '--args', 'process.py', '--tasks', '50', '--set-env-vars', 'BUCKET_NAME=hrdp_gcs_data_eu_${BRANCH_NAME}',
#           '--set-env-vars', 'SOURCE_FILE_PATH=successfactors/PMG/employee_goals_list',
#           '--set-env-vars', 'SECRET_NAME=api_auth_${BRANCH_NAME}',
#           '--max-retries', '0', '--task-timeout', '5400',
#           '--service-account', 'hrdp-sa-composer-${BRANCH_NAME}@itg-hranalytics-gbl-ww-${BRANCH_NAME}.iam.gserviceaccount.com',
#           '--region', 'europe-west1', '--project', '${PROJECT_ID}']
  # [END cloudbuild_python_deploy_yaml]

  #[ START cloudbuild_python_deploy_yaml ]
  # Deploy to Cloud Run
  - name: google/cloud-sdk
    args: [ 'gcloud', 'beta', 'run', 'jobs', 'deploy', 'hrdp-cr-parallel-api-ew1-${BRANCH_NAME}',
            '--image=europe-west1-docker.pkg.dev/${PROJECT_ID}/hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}/cloud-run-parallel-api:latest',
            '--command','python','--tasks', '50', '--set-env-vars', 'BUCKET_NAME=hrdp_gcs_data_eu_${BRANCH_NAME}',
            '--set-secrets', 'SECRET_NAME=api_auth_${BRANCH_NAME}:latest',
            '--max-retries', '0', '--task-timeout', '5400',
            '--network', 'projects/itg-hranalytics-gbl-ww-${BRANCH_NAME}/global/networks/itg-hranalytics-gbl-ww-${BRANCH_NAME}-vpc',
            '--subnet', 'projects/itg-hranalytics-gbl-ww-${BRANCH_NAME}/regions/europe-west1/subnetworks/itg-hranalytics-gbl-ww-${BRANCH_NAME}-vpc',
            '--vpc-egress', 'private-ranges-only',
            '--service-account', 'hrdp-sa-composer-${BRANCH_NAME}@itg-hranalytics-gbl-ww-${BRANCH_NAME}.iam.gserviceaccount.com',
            '--region', 'europe-west1', '--project', '${PROJECT_ID}' ]
  # [END cloudbuild_python_deploy_yaml]
#gcloud run deploy SERVICE \
  #--image IMAGE_URL \
  #--update-secrets=SECRET_NAME=api_auth_dv:latest
  #[ START cloudbuild_python_deploy_yaml ]
  # Deploy to Cloud Run
#  - name: google/cloud-sdk
#    args: [ 'gcloud', 'run', 'jobs', 'deploy', 'hrdp-cr-forms-cloud-run-ew1-${BRANCH_NAME}',
#            '--image=europe-west1-docker.pkg.dev/${PROJECT_ID}/hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}/cloud-run-parallel-api:latest',
#            '--command','python', '--args', 'form_process.py', '--tasks', '50', '--set-env-vars', 'BUCKET_NAME=hrdp_gcs_data_eu_${BRANCH_NAME}',
#            '--set-env-vars', 'SOURCE_FILE_PATH=successfactors/PMG/employee_forms_list',
#            '--set-env-vars', 'SECRET_NAME=api_auth_${BRANCH_NAME}',
#            '--max-retries', '0', '--task-timeout', '5400',
#            '--service-account', 'hrdp-sa-composer-${BRANCH_NAME}@itg-hranalytics-gbl-ww-${BRANCH_NAME}.iam.gserviceaccount.com',
#            '--region', 'europe-west1', '--project', '${PROJECT_ID}' ]
  # [END cloudbuild_python_deploy_yaml]

# Store images in Google Artifact Registry 
images:
  - europe-west1-docker.pkg.dev/${PROJECT_ID}/hrdp-cr-apicall-parallel-ew1-${BRANCH_NAME}/cloud-run-parallel-api:latest
# [END cloudbuild_python_yaml]
options:
    substitution_option: 'ALLOW_LOOSE'
    logging: CLOUD_LOGGING_ONLY